@inject IJSRuntime JS

<div class="avatars-container">
    <svg class="avatars-svg" viewBox="0 0 520 360" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <defs
     id="defs2183" />
  <rect
     x="0"
     y="0"
     width="520"
     height="360"
     rx="28"
     fill="#e8e9ed"
     id="rect2097" />
  <!-- Character Light Pink -->
  <g
     id="g3382"
     transform="matrix(1.0646298,0,0,1.0646298,-3.5271752,-7.6124358)">
    <!-- Body -->
    <path
       d="m 287.68597,326.75569 v -160 a 67.329095,60 0 0 1 134.65819,0 v 160 z"
       fill="#f6a8c9"
       id="path2117"
       style="stroke-width:1.05932" />
    <!--Cyclope eye -->
    <g
       id="g3366"
       transform="translate(4.6645401)"
       class="eye-group">
      <circle
         cx="350.35052"
         cy="168.00954"
         r="30"
         fill="#ffffff"
         id="circle2119"
         class="eye-white" />
      <circle
         cx="350.35052"
         cy="168.00954"
         r="12"
         fill="#000000"
         id="circle2121"
         class="pupil"
         data-eye-x="350.35052"
         data-eye-y="168.00954"
         data-max-distance="15" />
    </g>
    <!-- Mouth -->
    <g id="g3371" class="mouth-group" style="cursor: pointer;">
      <!-- Mouth Background -->
      <ellipse
         style="fill:#9d5874;fill-opacity:1"
         id="path3102"
         cx="394.302"
         cy="233.61568"
         rx="13.345692"
         ry="17.051718"
         class="mouth-part" />
      <!-- Mouth Teeth -->
      <rect
         x="385.38785"
         y="217.96416"
         width="8.449502"
         height="11.912072"
         rx="4.224751"
         fill="#ffffff"
         id="rect2125"
         style="stroke-width:1.3523"
        />
      <rect
         x="394.87283"
         y="217.67513"
         width="8.449502"
         height="11.912072"
         rx="4.224751"
         fill="#ffffff"
         id="rect3244"
         style="stroke-width:1.3523"
        />
      <!-- Superior lip -->
      <ellipse
         style="fill:#f6a8c9;fill-opacity:1;stroke-width:1.40024"
         id="path3362"
         cx="393.32635"
         cy="215.4073"
         rx="13.578872"
         ry="7.5488887"
         class="mouth-part" />
    </g>
  </g>
  <!-- Character Dark Pink -->
  <g
     id="g2685"
     transform="matrix(1.0646298,0,0,1.0646298,47.609429,-19.208797)">
    <!-- Left leg -->
    <path
       d="m 102.27613,124.20905 20,200"
       stroke="#e84e7e"
       stroke-width="24"
       stroke-linecap="round"
       id="path2099" />
    <!-- Right leg -->
    <path
       d="m 132.70674,123.08628 c 19.75062,67.35436 39.84025,133.80623 59.18332,202.24554"
       stroke="#e84e7e"
       stroke-width="24"
       stroke-linecap="round"
       id="path2101" />
    <!-- Face -->
    <rect
       x="23.910538"
       y="63.605251"
       width="192.60803"
       height="61.414959"
       rx="31.963337"
       fill="#e84e7e"
       id="rect2103"
       style="stroke-width:0.9192" />
    <!-- Eyes -->
    <g class="eye-group">
      <circle
         cx="98.130707"
         cy="59.778286"
         fill="#ffffff"
         id="circle2105"
         style="stroke-width:0.8"
         r="20"
         class="eye-white" />
      <circle
         cx="98.130707"
         cy="59.778286"
         r="8"
         fill="#000000"
         id="circle2107"
         class="pupil"
         data-eye-x="98.130707"
         data-eye-y="59.778286"
         data-max-distance="10" />
    </g>
    <g class="eye-group">
      <circle
         cx="142.2984"
         cy="59.778286"
         fill="#ffffff"
         id="circle2109"
         style="stroke-width:0.799996"
         r="20"
         class="eye-white" />
      <circle
         cx="142.2984"
         cy="59.778286"
         r="8"
         fill="#000000"
         id="circle2111"
         class="pupil"
         data-eye-x="142.2984"
         data-eye-y="59.778286"
         data-max-distance="10" />
    </g>
    <!-- Mouth -->
    <g class="mouth-group">
      <rect
         x="100.42516"
         y="86.254997"
         width="39.578777"
         height="22.523483"
         rx="11.933199"
         fill="#e84e7e"
         id="rect2103-6"
         style="fill:#9d2b48;fill-opacity:1;stroke-width:0.9192;cursor:pointer;"
         class="mouth-part" />
    </g>
  </g>
  <!-- Character Blue -->
  <g
     id="g3100"
     transform="matrix(1.0646298,0,0,1.0646298,35.444467,-8.0077582)">
    <g
       id="g3081">
      <!-- Legs -->
      <g
         id="g3069"
         transform="translate(6.0769958)">
        <rect
           x="193.81808"
           y="227.29317"
           width="16"
           height="101.20235"
           rx="8"
           fill="#3b95f5"
           id="rect2161"
           style="stroke-width:1.29873" />
        <rect
           x="223.81808"
           y="227.29317"
           width="16"
           height="101.1306"
           rx="8"
           fill="#3b95f5"
           id="rect2163"
           style="stroke-width:1.29827" />
      </g>
      <!-- Face -->
      <ellipse
         cx="222.89508"
         cy="221.67238"
         fill="#3b95f5"
         id="circle2165"
         rx="52.895084"
         ry="51.672386"
         style="stroke-width:1.08917" />
      <!-- Eyes -->
      <g
         id="g3009"
         transform="translate(4.0769958)">
        <g class="eye-group">
          <circle
             cx="201.81808"
             cy="207.29317"
             r="16"
             fill="#ffffff"
             id="circle2167"
             class="eye-white" />
          <circle
             cx="201.81808"
             cy="207.29317"
             r="7"
             fill="#000000"
             id="circle2169"
             class="pupil"
             data-eye-x="201.81808"
             data-eye-y="207.29317"
             data-max-distance="8" />
        </g>
        <g class="eye-group">
          <circle
             cx="235.81808"
             cy="207.29317"
             r="16"
             fill="#ffffff"
             id="circle2171"
             class="eye-white" />
          <circle
             cx="235.81808"
             cy="207.29317"
             r="7"
             fill="#000000"
             id="circle2173"
             class="pupil"
             data-eye-x="235.81808"
             data-eye-y="207.29317"
             data-max-distance="8" />
        </g>
      </g>
      <!-- Mouth -->
      <g class="mouth-group">
        <ellipse
           cx="222.89508"
           cy="239.01947"
           fill="#1e4f84"
           id="circle2175"
           rx="10"
           ry="7.78826"
           style="stroke-width:0.882511;cursor:pointer;"
           class="mouth-part" />
      </g>
    </g>
  </g>
  <!-- Cloud Character -->
  <g
     id="g3640"
     transform="matrix(1.0646298,0,0,1.0646298,-20.690737,-16.388903)">
    <g
       id="g3617">
      <!-- Left leg -->
      <rect
         x="122.05357"
         y="232.48087"
         width="11.825696"
         height="102.44677"
         rx="5.912848"
         fill="#80d8d0"
         id="rect2131"
         style="stroke-width:1.04005" />
      <!-- Right leg -->
      <rect
         x="147.39435"
         y="232.48087"
         width="11.825696"
         height="100.29401"
         rx="5.912848"
         fill="#80d8d0"
         id="rect2133"
         style="stroke-width:1.02906" />
      <!-- Body -->
      <g
         id="g3601">
        <ellipse
           style="fill:#80d8d0;fill-opacity:1;stroke-width:1.32798"
           id="path2920"
           cx="115.99339"
           cy="163.7532"
           rx="20.364809"
           ry="19.127666" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1;stroke-width:0.917099"
           id="path2912"
           cx="142.52177"
           cy="197.85033"
           rx="45.54929"
           ry="45.638149" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1;stroke-width:0.994873"
           id="path2934"
           cx="116.27796"
           cy="228.69908"
           rx="16.505699"
           ry="18.288988" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1;stroke-width:1.0984"
           id="path2914"
           cx="169.74838"
           cy="156.09468"
           rx="20.43363"
           ry="16.408358" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1;stroke-width:1.33143"
           id="path2918"
           cx="142.69867"
           cy="153.49768"
           rx="17.821531"
           ry="17.636358" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1"
           id="path2922"
           cx="97.165756"
           cy="187.5155"
           rx="15.63154"
           ry="12.542776" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1"
           id="path2924"
           cx="188.26883"
           cy="179.82002"
           rx="16.120945"
           ry="16.68458" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1;stroke-width:1.13898"
           id="path2928"
           cx="188.91353"
           cy="214.07585"
           rx="17.204527"
           ry="22.044638" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1"
           id="path2930"
           cx="169.03401"
           cy="236.33124"
           rx="15.812964"
           ry="17.526491" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1;stroke-width:1.21242"
           id="path2932"
           cx="102.81811"
           cy="207.98312"
           rx="15.461748"
           ry="16.934301" />
        <ellipse
           style="fill:#80d8d0;fill-opacity:1"
           id="path2936"
           cx="140.21169"
           cy="241.29031"
           rx="17.891291"
           ry="15.915248" />
      </g>
    </g>
    <!-- Eyes -->
    <g
       id="g2974"
       transform="translate(56.498256,-2.656385)">
      <g class="eye-group">
        <circle
           cx="73.545761"
           cy="183.32991"
           fill="#ffffff"
           id="circle2149"
           style="stroke-width:0.892857"
           r="12.5"
           class="eye-white" />
        <circle
           cx="73.545761"
           cy="183.32991"
           fill="#000000"
           id="circle2151"
           style="stroke-width:1.25"
           r="4.5"
           class="pupil"
           data-eye-x="73.545761"
           data-eye-y="183.32991"
           data-max-distance="6" />
      </g>
      <g class="eye-group">
        <circle
           cx="101.10999"
           cy="183.32991"
           fill="#ffffff"
           id="circle2153"
           style="stroke-width:0.892857"
           r="12.5"
           class="eye-white" />
        <circle
           cx="101.10999"
           cy="183.32991"
           fill="#000000"
           id="circle2155"
           style="stroke-width:1.25"
           r="4.5"
           class="pupil"
           data-eye-x="101.10999"
           data-eye-y="183.32991"
           data-max-distance="6" />
      </g>
    </g>
    <!-- Mouth -->
    <g class="mouth-group">
      <ellipse
         cx="131.6028"
         cy="213.79271"
         fill="#3e7a77"
         id="circle2157"
         rx="11.527838"
         ry="9.2636528"
         style="stroke-width:1.22883;cursor:pointer;"
         class="mouth-part" />
    </g>
  </g>
  <!-- Floor -->
  <rect
     style="fill:#e8e9ed;fill-opacity:1;stroke-width:0.674335"
     id="rect3490"
     width="482.37091"
     height="24.073071"
     x="15.045849"
     y="325.81213"
     rx="0" />
    </svg>
</div>

<style>
    .avatars-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatars-svg {
        width: 100%;
        height: auto;
    }

    .pupil {
        transition: transform 0.08s ease-out;
        transform-origin: center;
        transform-box: fill-box;
    }

    .pupil.focused {
        transform: scale(1.4);
    }

    .mouth-part {
        transition: transform 0.2s ease-out;
        transform-origin: center;
        transform-box: fill-box;
    }
</style>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initAvatarAnimations");
        }
    }
}

<script>
    window.initAvatarAnimations = () => {
        const loginPage = document.querySelector('.login-page');
        const rightPanel = document.querySelector('.right-panel');
        const svg = document.querySelector('.avatars-svg');
        
        if (!loginPage || !svg) return;

        const pupils = svg.querySelectorAll('.pupil');
        const mouthGroups = svg.querySelectorAll('.mouth-group');
        
        // Form elements that activate animation
        const loginButton = document.querySelector('.btn-login');
        const passwordInput = document.querySelector('input[type="password"]');

        let currentPupilScale = 1.0;

        // --- Eye movement logic ---
        const moveEyes = (e) => {
            const svgRect = svg.getBoundingClientRect();
            const mouseX = e.clientX - svgRect.left;
            const mouseY = e.clientY - svgRect.top;
            const viewBox = svg.viewBox.baseVal;
            const scaleX = viewBox.width / svgRect.width;
            const scaleY = viewBox.height / svgRect.height;
            const svgMouseX = mouseX * scaleX;
            const svgMouseY = mouseY * scaleY;

            pupils.forEach(pupil => {
                const eyeX = parseFloat(pupil.getAttribute('data-eye-x'));
                const eyeY = parseFloat(pupil.getAttribute('data-eye-y'));
                const maxDistance = parseFloat(pupil.getAttribute('data-max-distance'));
                const dx = svgMouseX - eyeX;
                const dy = svgMouseY - eyeY;
                const angle = Math.atan2(dy, dx);
                const distance = Math.sqrt(dx * dx + dy * dy);
                const moveDistance = distance > 50 ? maxDistance : Math.min(maxDistance, distance / 15);
                const offsetX = Math.cos(angle) * moveDistance;
                const offsetY = Math.sin(angle) * moveDistance;
                
                // Use actual scale factor for transform
                const scale = currentPupilScale;
                pupil.setAttribute('transform', `scale(${scale}) translate(${offsetX/scale}, ${offsetY/scale})`);
            });
        };

        loginPage.addEventListener('mousemove', moveEyes);

        // --- Pupils scale logic---
        const setPupilScale = (scaleValue) => {
            currentPupilScale = scaleValue;
            // Force and update from eye position to apply the scale immediately
            const lastMouseEvent = new MouseEvent('mousemove', { bubbles: true, cancelable: true, view: window, clientX: window.lastMouseX, clientY: window.lastMouseY });
            loginPage.dispatchEvent(lastMouseEvent);
        };

        if (loginButton) {
            loginButton.addEventListener('mouseenter', () => setPupilScale(1.4));
            loginButton.addEventListener('mouseleave', () => setPupilScale(1.0));
        }
        if (passwordInput) {
            passwordInput.addEventListener('focus', () => setPupilScale(1.2));
            passwordInput.addEventListener('blur', () => setPupilScale(1.0));
        }
        
        // Save the last mouse position for use it to force updating
        window.addEventListener('mousemove', e => {
            window.lastMouseX = e.clientX;
            window.lastMouseY = e.clientY;
        }, { passive: true });


        // --- Mouth animation ---
        mouthGroups.forEach(group => {
            const parts = group.querySelectorAll('.mouth-part');
            const interactiveElement = group.querySelector('[style*="cursor:pointer"]') || group;

            interactiveElement.addEventListener('mouseenter', () => {
                parts.forEach(part => {
                    part.style.transform = 'scale(1.5)';
                });
            });

            interactiveElement.addEventListener('mouseleave', () => {
                parts.forEach(part => {
                    part.style.transform = 'scale(1)';
                });
            });
        });
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', window.initAvatarAnimations);
    } else {
        window.initAvatarAnimations();
    }
</script>