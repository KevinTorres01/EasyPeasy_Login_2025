@page "/admin/network-configuration"
@layout EasyPeasy_Login.Web.Components.Layout.AdminLayout
@rendermode InteractiveServer
@using EasyPeasy_Login.Infrastructure.Network.Configuration
@inject INetworkConfigurationService NetworkService
@inject IJSRuntime JS

<PageTitle>Network Configuration</PageTitle>

<div class="dashboard-page">
    <div class="top-header">
        <h1 class="page-tittle">Network Configuration</h1>
    </div>

    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Network Setup Wizard</h1>
                <p class="page-description">Configure your network interface and access point</p>
            </div>
        </div>
    </div>

    <!-- Configuration Form -->
    <div class="config-container">
        @if (!isConfiguring && !configurationComplete)
        {
            <div class="config-form">
                <h3>Network Configuration Parameters</h3>
                
                <div class="form-group">
                    <label for="interface">WiFi Interface:</label>
                    <input type="text" id="interface" @bind="configParams.Interface" 
                           class="form-control" placeholder="e.g., wlp2s0" />
                    <small class="form-text">The wireless network interface that will host the access point</small>
                </div>

                <div class="form-group">
                    <label for="upstream">Upstream Interface:</label>
                    <input type="text" id="upstream" @bind="configParams.UpstreamInterface" 
                           class="form-control" placeholder="e.g., eth0 or tun0" />
                    <small class="form-text">The interface with internet connection (ethernet or VPN)</small>
                </div>

                <div class="form-group">
                    <label for="vpn-check">
                        <input type="checkbox" id="vpn-check" @bind="configParams.IsVpnInterface" />
                        Is VPN Interface (tun/tap)?
                    </label>
                </div>

                <div class="form-group">
                    <label for="gateway">Gateway IP Address:</label>
                    <input type="text" id="gateway" @bind="configParams.GatewayIp" 
                           class="form-control" placeholder="e.g., 192.168.100.1" />
                    <small class="form-text">The IP address for this access point</small>
                </div>

                <div class="form-group">
                    <label for="dhcp">DHCP Range:</label>
                    <input type="text" id="dhcp" @bind="configParams.DhcpRange" 
                           class="form-control" placeholder="e.g., 192.168.100.50,192.168.100.150" />
                    <small class="form-text">IP range for connected clients (start,end)</small>
                </div>

                <div class="form-group">
                    <label for="ssid">WiFi SSID:</label>
                    <input type="text" id="ssid" @bind="configParams.Ssid" 
                           class="form-control" placeholder="e.g., EasyPeasy_Guest" />
                    <small class="form-text">The name of your wireless network</small>
                </div>

                <div class="form-group">
                    <label for="password">WiFi Password:</label>
                    <input type="password" id="password" @bind="configParams.Password" 
                           class="form-control" placeholder="Minimum 8 characters" />
                    <small class="form-text">Password for the wireless network (min. 8 chars)</small>
                </div>

                <div class="form-actions">
                    <button class="btn-primary" @onclick="StartConfiguration" disabled="@(!IsFormValid())">
                        <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm40-68a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V88a8,8,0,0,1,16,0v52h24A8,8,0,0,1,168,148Z"/>
                        </svg>
                        Start Configuration
                    </button>
                    <button class="btn-secondary" @onclick="LoadDefaults">
                        Load Default Values
                    </button>
                </div>
            </div>
        }

        <!-- Configuration Progress -->
        @if (isConfiguring)
        {
            <div class="config-progress">
                <h3>Configuration in Progress...</h3>
                <div class="spinner"></div>
                <p class="status-text">Please wait while the network is being configured</p>
            </div>
        }

        <!-- Configuration Complete -->
        @if (configurationComplete)
        {
            <div class="config-complete">
                <div class="@(configurationSuccess ? "success-icon" : "error-icon")">
                    @if (configurationSuccess)
                    {
                        <svg viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"/>
                        </svg>
                    }
                    else
                    {
                        <svg viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-80V80a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm20,36a12,12,0,1,1-12-12A12,12,0,0,1,140,172Z"/>
                        </svg>
                    }
                </div>
                <h3>@(configurationSuccess ? "Configuration Successful!" : "Configuration Failed")</h3>
                <p>@(configurationSuccess ? "The network has been configured successfully." : "There was an error during configuration.")</p>
                <div class="form-actions">
                    <button class="btn-primary" @onclick="ResetForm">
                        Configure Again
                    </button>
                    @if (configurationSuccess)
                    {
                        <button class="btn-secondary" @onclick="RestoreConfiguration">
                            Restore Original Configuration
                        </button>
                    }
                </div>
            </div>
        }

        <!-- Log Console -->
        <div class="log-console">
            <div class="log-header">
                <h3>Configuration Log</h3>
                <button class="btn-clear" @onclick="ClearLogs">Clear</button>
            </div>
            <div class="log-content" @ref="logContainer">
                @foreach (var log in logs)
                {
                    <div class="log-entry @GetLogClass(log)">@log</div>
                }
            </div>
        </div>

        <!-- Network Information -->
        @if (!string.IsNullOrEmpty(networkInfo))
        {
            <div class="network-info">
                <h3>Current Network Information</h3>
                <pre>@networkInfo</pre>
            </div>
        }
        
        <div class="form-actions">
            <button class="btn-secondary" @onclick="LoadNetworkInfo">
                Refresh Network Info
            </button>
        </div>
    </div>
</div>

<style>
    .config-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .config-form {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .config-form h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #4CAF50;
    }

    .form-text {
        display: block;
        margin-top: 0.25rem;
        color: #666;
        font-size: 0.875rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-primary, .btn-secondary, .btn-clear {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background-color: #4CAF50;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #45a049;
    }

    .btn-primary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: #666;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #555;
    }

    .btn-clear {
        padding: 0.5rem 1rem;
        background-color: #f44336;
        color: white;
        font-size: 0.875rem;
    }

    .btn-clear:hover {
        background-color: #da190b;
    }

    .btn-icon {
        width: 20px;
        height: 20px;
    }

    .config-progress {
        background: white;
        border-radius: 8px;
        padding: 3rem 2rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .spinner {
        width: 50px;
        height: 50px;
        margin: 2rem auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4CAF50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .status-text {
        color: #666;
        margin-top: 1rem;
    }

    .config-complete {
        background: white;
        border-radius: 8px;
        padding: 3rem 2rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .success-icon, .error-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1rem;
    }

    .success-icon svg {
        fill: #4CAF50;
    }

    .error-icon svg {
        fill: #f44336;
    }

    .log-console {
        background: #1e1e1e;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .log-header {
        background: #2d2d2d;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .log-header h3 {
        margin: 0;
        color: #fff;
        font-size: 1rem;
    }

    .log-content {
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
    }

    .log-entry {
        color: #d4d4d4;
        padding: 0.25rem 0;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .log-entry.error {
        color: #f48771;
    }

    .log-entry.success {
        color: #4ec9b0;
    }

    .log-entry.warning {
        color: #dcdcaa;
    }

    .network-info {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .network-info h3 {
        margin-top: 0;
        margin-bottom: 1rem;
    }

    .network-info pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 0.875rem;
    }
</style>

@code {
    private NetworkConfigurationParams configParams = new();
    private List<string> logs = new();
    private bool isConfiguring = false;
    private bool configurationComplete = false;
    private bool configurationSuccess = false;
    private string? networkInfo;
    private ElementReference logContainer;

    protected override void OnInitialized()
    {
        NetworkService.LogReceived += OnLogReceived;
        LoadDefaults();
    }

    private void LoadDefaults()
    {
        configParams = new NetworkConfigurationParams
        {
            Interface = "wlp2s0",
            UpstreamInterface = "eth0",
            GatewayIp = "192.168.100.1",
            DhcpRange = "192.168.100.50,192.168.100.150",
            Ssid = "EasyPeasy_Guest",
            Password = "12345678",
            IsVpnInterface = false
        };
    }

    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(configParams.Interface) &&
               !string.IsNullOrWhiteSpace(configParams.UpstreamInterface) &&
               !string.IsNullOrWhiteSpace(configParams.GatewayIp) &&
               !string.IsNullOrWhiteSpace(configParams.DhcpRange) &&
               !string.IsNullOrWhiteSpace(configParams.Ssid) &&
               !string.IsNullOrWhiteSpace(configParams.Password) &&
               configParams.Password.Length >= 8;
    }

    private async Task StartConfiguration()
    {
        isConfiguring = true;
        configurationComplete = false;
        logs.Clear();
        StateHasChanged();

        try
        {
            configurationSuccess = await NetworkService.SetupNetworkAsync(configParams);
        }
        catch (Exception ex)
        {
            AddLog($"ERROR: {ex.Message}");
            configurationSuccess = false;
        }
        finally
        {
            isConfiguring = false;
            configurationComplete = true;
            StateHasChanged();
        }
    }

    private async Task RestoreConfiguration()
    {
        isConfiguring = true;
        StateHasChanged();

        try
        {
            await NetworkService.RestoreConfigurationAsync();
            AddLog("Configuration restored successfully");
        }
        catch (Exception ex)
        {
            AddLog($"ERROR restoring configuration: {ex.Message}");
        }
        finally
        {
            isConfiguring = false;
            StateHasChanged();
        }
    }

    private void ResetForm()
    {
        configurationComplete = false;
        configurationSuccess = false;
        StateHasChanged();
    }

    private async Task LoadNetworkInfo()
    {
        try
        {
            networkInfo = await NetworkService.GetCurrentNetworkInfoAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            AddLog($"ERROR loading network info: {ex.Message}");
        }
    }

    private void OnLogReceived(object? sender, string message)
    {
        AddLog(message);
    }

    private void AddLog(string message)
    {
        logs.Add(message);
        InvokeAsync(() =>
        {
            StateHasChanged();
            ScrollToBottom();
        });
    }

    private async void ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", "document.querySelector('.log-content').scrollTop = document.querySelector('.log-content').scrollHeight");
        }
        catch { }
    }

    private void ClearLogs()
    {
        logs.Clear();
        StateHasChanged();
    }

    private string GetLogClass(string log)
    {
        if (log.Contains("ERROR") || log.Contains("failed"))
            return "error";
        if (log.Contains("âœ“") || log.Contains("success"))
            return "success";
        if (log.Contains("Warning") || log.Contains("==="))
            return "warning";
        return "";
    }

    public void Dispose()
    {
        NetworkService.LogReceived -= OnLogReceived;
    }
}
