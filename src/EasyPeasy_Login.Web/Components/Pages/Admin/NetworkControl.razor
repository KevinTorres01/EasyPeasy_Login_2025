@page "/admin/network"
@using EasyPeasy_Login.Infrastructure.Network.Configuration
@using EasyPeasy_Login.Shared
@using EasyPeasy_Login.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Web
@layout EasyPeasy_Login.Web.Components.Layout.AdminLayout
@rendermode InteractiveServer
@inject INetworkOrchestrator NetworkOrchestrator
@inject INetworkConfiguration NetworkConfig
@inject ILogger Logger

<Microsoft.AspNetCore.Components.Web.PageTitle>Network Control - Admin</Microsoft.AspNetCore.Components.Web.PageTitle>

<div class="network-control-page">
    <div class="top-header">
        <h1 class="page-tittle">Administrator System</h1>
    </div>

    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Network Control</h1>
                <p class="page-description">Configure and manage the Captive Portal Access Point</p>
            </div>
            <div class="network-status @(NetworkConfig.IsNetworkActive ? "status-active" : "status-inactive")">
                <span class="status-dot"></span>
                <span class="status-text">@(NetworkConfig.IsNetworkActive ? "Network Active" : "Network Inactive")</span>
            </div>
        </div>
    </div>

    <div class="network-content">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="panel-section">
                <h3 class="section-title">
                    <svg class="section-icon" viewBox="0 0 256 256" fill="currentColor">
                        <path d="M247.89,124.3C234.36,100.51,200.66,56,128,56S21.64,100.51,8.11,124.3a15.93,15.93,0,0,0,0,15.4C21.64,163.49,55.34,208,128,208s106.36-44.51,119.89-68.3A15.93,15.93,0,0,0,247.89,124.3ZM128,192c-63.06,0-91.43-40.56-103.09-64C36.57,104.56,64.94,64,128,64s91.43,40.56,103.09,64C219.43,151.44,191.06,192,128,192Zm0-112a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Z"/>
                    </svg>
                    Network Actions
                </h3>
                <div class="action-buttons">
                    <button class="btn-action btn-start @(NetworkConfig.IsNetworkActive ? "disabled" : "")" 
                            @onclick="StartNetwork" 
                            disabled="@(_isLoading || NetworkConfig.IsNetworkActive)">
                        @if (_isLoading && _currentAction == "start")
                        {
                            <span class="spinner"></span>
                            <span>Starting...</span>
                        }
                        else
                        {
                            <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor">
                                <path d="M232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128ZM128,48a80,80,0,1,0,80,80A80.09,80.09,0,0,0,128,48Zm36.44,77.66-48-32A8,8,0,0,0,104,100v64a8,8,0,0,0,12.44,6.66l48-32a8,8,0,0,0,0-13.32Z"/>
                            </svg>
                            <span>Start Network</span>
                        }
                    </button>
                    <button class="btn-action btn-stop @(!NetworkConfig.IsNetworkActive ? "disabled" : "")" 
                            @onclick="StopNetwork" 
                            >
                        @if (_isLoading && _currentAction == "stop")
                        {
                            <span class="spinner"></span>
                            <span>Stopping...</span>
                        }
                        else
                        {
                            <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor">
                                <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm24-120v64a8,8,0,0,1-16,0V96a8,8,0,0,1,16,0Zm-40,0v64a8,8,0,0,1-16,0V96a8,8,0,0,1,16,0Z"/>
                            </svg>
                            <span>Stop Network</span>
                        }
                    </button>
                </div>
            </div>

            <!-- Runtime Info -->
            @if (NetworkConfig.IsNetworkActive)
            {
                <div class="panel-section runtime-info">
                    <h3 class="section-title">
                        <svg class="section-icon" viewBox="0 0 256 256" fill="currentColor">
                            <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-80V80a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm20,36a12,12,0,1,1-12-12A12,12,0,0,1,140,172Z"/>
                        </svg>
                        Runtime Information
                    </h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Upstream Interface:</span>
                            <span class="info-value">@(NetworkConfig.UpstreamInterface ?? "Not detected")</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">VPN Interface:</span>
                            <span class="info-value @(NetworkConfig.IsVpnInterface ? "vpn-active" : "")">
                                @(NetworkConfig.IsVpnInterface ? "Yes ðŸ”’" : "No")
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Portal URL:</span>
                            <span class="info-value url">http://@NetworkConfig.GatewayIp:@NetworkConfig.DefaultPort/portal</span>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <div class="panel-header">
                <h3 class="section-title">
                    <svg class="section-icon" viewBox="0 0 256 256" fill="currentColor">
                        <path d="M128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Zm88-29.84q.06-2.16,0-4.32l14.92-18.64a8,8,0,0,0,1.48-7.06,107.21,107.21,0,0,0-10.88-26.25,8,8,0,0,0-6-3.93l-23.72-2.64q-1.48-1.56-3-3L186,40.54a8,8,0,0,0-3.94-6,107.71,107.71,0,0,0-26.25-10.87,8,8,0,0,0-7.06,1.49L130.16,40Q128,40,125.84,40L107.2,25.11a8,8,0,0,0-7.06-1.48A107.6,107.6,0,0,0,73.89,34.51a8,8,0,0,0-3.93,6L67.32,64.27q-1.56,1.49-3,3L40.54,70a8,8,0,0,0-6,3.94,107.71,107.71,0,0,0-10.87,26.25,8,8,0,0,0,1.49,7.06L40,125.84Q40,128,40,130.16L25.11,148.8a8,8,0,0,0-1.48,7.06,107.21,107.21,0,0,0,10.88,26.25,8,8,0,0,0,6,3.93l23.72,2.64q1.49,1.56,3,3L70,215.46a8,8,0,0,0,3.94,6,107.71,107.71,0,0,0,26.25,10.87,8,8,0,0,0,7.06-1.49L125.84,216q2.16.06,4.32,0l18.64,14.92a8,8,0,0,0,7.06,1.48,107.21,107.21,0,0,0,26.25-10.88,8,8,0,0,0,3.93-6l2.64-23.72q1.56-1.48,3-3L215.46,186a8,8,0,0,0,6-3.94,107.71,107.71,0,0,0,10.87-26.25,8,8,0,0,0-1.49-7.06Z"/>
                    </svg>
                    Network Configuration
                </h3>
                <button class="btn-reset" @onclick="ResetToDefaults" disabled="@NetworkConfig.IsNetworkActive" title="Reset to defaults">
                    <svg viewBox="0 0 256 256" fill="currentColor">
                        <path d="M224,48V96a8,8,0,0,1-8,8H168a8,8,0,0,1,0-16h28.69L182.06,73.37a79.56,79.56,0,0,0-56.13-23.43h-.45A79.52,79.52,0,0,0,69.59,72.71,8,8,0,0,1,58.41,61.27a96,96,0,0,1,135,.79L208,76.69V48a8,8,0,0,1,16,0ZM186.41,183.29a80,80,0,0,1-112.47-.78L59.31,168H88a8,8,0,0,0,0-16H40a8,8,0,0,0-8,8v48a8,8,0,0,0,16,0V179.31l14.63,14.63A95.43,95.43,0,0,0,130,222.06h.53a95.36,95.36,0,0,0,67.07-27.33,8,8,0,0,0-11.18-11.44Z"/>
                    </svg>
                </button>
            </div>
            
            @if (NetworkConfig.IsNetworkActive)
            {
                <div class="config-locked-notice">
                    <svg viewBox="0 0 256 256" fill="currentColor">
                        <path d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Zm-80-40a12,12,0,1,1,12-12A12,12,0,0,1,128,168Z"/>
                    </svg>
                    <span>Configuration is locked while network is active. Stop the network to make changes.</span>
                </div>
            }
            
            <div class="config-form @(NetworkConfig.IsNetworkActive ? "form-disabled" : "")">
                <div class="form-row">
                    <div class="form-group">
                        <label for="interface">WiFi Interface</label>
                        <input type="text" id="interface" @bind="NetworkConfig.Interface" 
                               disabled="@NetworkConfig.IsNetworkActive" placeholder="e.g., wlan0" />
                        <span class="form-hint">The wireless interface to use for the Access Point</span>
                    </div>
                    <div class="form-group">
                        <label for="ssid">Network Name (SSID)</label>
                        <input type="text" id="ssid" @bind="NetworkConfig.Ssid" 
                               disabled="@NetworkConfig.IsNetworkActive" placeholder="e.g., MyNetwork" />
                        <span class="form-hint">The name users will see when connecting</span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="password">WiFi Password</label>
                        <div class="password-input">
                            <input type="@(_showPassword ? "text" : "password")" id="password" 
                                   @bind="NetworkConfig.Password" disabled="@NetworkConfig.IsNetworkActive" 
                                   placeholder="Minimum 8 characters" />
                            <button type="button" class="btn-toggle-password" @onclick="TogglePasswordVisibility">
                                @if (_showPassword)
                                {
                                    <svg viewBox="0 0 256 256" fill="currentColor">
                                        <path d="M228,175a8,8,0,0,1-10.92-3l-19-33.2A123.23,123.23,0,0,1,162,155.46l5.87,35.22a8,8,0,0,1-6.58,9.21A8.4,8.4,0,0,1,160,200a8,8,0,0,1-7.88-6.69l-5.77-34.58a133.06,133.06,0,0,1-36.68,0l-5.77,34.58A8,8,0,0,1,96,200a8.4,8.4,0,0,1-1.32-.11,8,8,0,0,1-6.58-9.21L94,155.46a123.23,123.23,0,0,1-36.06-16.69L38.92,172A8,8,0,1,1,25.08,164l20-35a153.47,153.47,0,0,1-19.3-20A8,8,0,1,1,38.22,99a135.86,135.86,0,0,0,99.73,53h.1a135.86,135.86,0,0,0,99.73-53,8,8,0,1,1,12.46,10,153.47,153.47,0,0,1-19.3,20l20,35A8,8,0,0,1,228,175Z"/>
                                    </svg>
                                }
                                else
                                {
                                    <svg viewBox="0 0 256 256" fill="currentColor">
                                        <path d="M247.31,124.76c-.35-.79-8.82-19.58-27.65-38.41C194.57,61.26,162.88,48,128,48S61.43,61.26,36.34,86.35C17.51,105.18,9,124,8.69,124.76a8,8,0,0,0,0,6.5c.35.79,8.82,19.57,27.65,38.4C61.43,194.74,93.12,208,128,208s66.57-13.26,91.66-38.34c18.83-18.83,27.3-37.61,27.65-38.4A8,8,0,0,0,247.31,124.76ZM128,192c-30.78,0-57.67-11.19-79.93-33.25A133.47,133.47,0,0,1,25,128,133.33,133.33,0,0,1,48.07,97.25C70.33,75.19,97.22,64,128,64s57.67,11.19,79.93,33.25A133.46,133.46,0,0,1,231.05,128C223.84,141.46,192.43,192,128,192Zm0-112a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Z"/>
                                    </svg>
                                }
                            </button>
                        </div>
                        <span class="form-hint">WPA2 password for the network</span>
                    </div>
                    <div class="form-group">
                        <label for="port">Portal Port</label>
                        <input type="number" id="port" @bind="NetworkConfig.DefaultPort" 
                               disabled="@NetworkConfig.IsNetworkActive" min="1" max="65535" />
                        <span class="form-hint">HTTP port for the captive portal</span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="gateway">Gateway IP</label>
                        <input type="text" id="gateway" @bind="NetworkConfig.GatewayIp" 
                               disabled="@NetworkConfig.IsNetworkActive" placeholder="e.g., 192.168.1.1" />
                        <span class="form-hint">The IP address of this device on the AP network</span>
                    </div>
                    <div class="form-group">
                        <label for="dhcp">DHCP Range</label>
                        <input type="text" id="dhcp" @bind="NetworkConfig.DhcpRange" 
                               disabled="@NetworkConfig.IsNetworkActive" placeholder="e.g., 192.168.1.50,192.168.1.150" />
                        <span class="form-hint">Range of IPs to assign to connected devices</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Console -->
    <LogConsole @bind-IsExpanded="_consoleExpanded" />
</div>

@code {
    private bool _isLoading = false;
    private string _currentAction = "";
    private bool _showPassword = false;
    private bool _consoleExpanded = true;
    private int _clickCount = 0;
    
    private async Task StartNetwork()
    {
        Logger.LogInfo("ðŸš€ Start Network button clicked");
        _isLoading = true;
        _currentAction = "start";
        StateHasChanged();

        try
        {
            Logger.LogInfo("ðŸ“¡ Calling SetUpNetwork...");
            var success = await NetworkOrchestrator.SetUpNetwork();
            NetworkConfig.IsNetworkActive = success;
            
            if (!success)
            {
                Logger.LogError("Failed to start network. Check the logs for details.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Exception starting network: {ex.Message}");
            NetworkConfig.IsNetworkActive = false;
        }
        finally
        {
            _isLoading = false;
            _currentAction = "";
            StateHasChanged();
        }
    }

    private async Task StopNetwork()
    {
        _isLoading = true;
        _currentAction = "stop";
        StateHasChanged();

        try
        {
            await NetworkOrchestrator.RestoreConfiguration();
            NetworkConfig.IsNetworkActive = false;
            Logger.LogInfo("Network stopped successfully.");
        }
        catch (Exception ex)
        {
            Logger.LogError($"Exception stopping network: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            _currentAction = "";
            StateHasChanged();
        }
    }

    private void ResetToDefaults()
    {
        if (!NetworkConfig.IsNetworkActive)
        {
            NetworkConfig.ResetToDefaults();
            Logger.LogInfo("Configuration reset to defaults.");
        }
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
    }
}
