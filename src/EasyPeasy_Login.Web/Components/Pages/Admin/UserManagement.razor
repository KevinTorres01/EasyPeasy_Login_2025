@page "/users"
@using Microsoft.AspNetCore.Components.Web
@using EasyPeasy_Login.Application.Services.UserManagement
@using EasyPeasy_Login.Application.DTOs
@layout EasyPeasy_Login.Web.Components.Layout.AdminLayout
@rendermode InteractiveServer
@inject IUserManagementService UserManagementService

<PageTitle>User Account Management</PageTitle>

<div class="users-page">
    <div class="top-header">
        <h1 class="page-tittle">Administrator System</h1>
    </div>

    <!-- Header -->
    <div class="page-header-wrapper">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">User Account Management</h1>
                <p class="page-description">Portal users management</p>
            </div>
            <button class="btn-add-user" @onclick="OpenAddUserModal">
                <svg class="btn-icon" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M228,128a12,12,0,0,1-12,12H140v76a12,12,0,0,1-24,0V140H40a12,12,0,0,1,0-24h76V40a12,12,0,0,1,24,0v76h76A12,12,0,0,1,228,128Z" />
                </svg>
                Add User
            </button>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-container">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 256 256" fill="currentColor">
                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"/>
            </svg>
            <input type="text" placeholder="Search by username, name, ..." @bind="searchTerm" @bind:event="oninput" />
        </div>
        <div class="filter-dropdown">
            <select @bind="statusFilter">
                <option value="all">Status: All</option>
                <option value="active">Status: Active</option>
                <option value="inactive">Status: Inactive</option>
            </select>
        </div>
    </div>

    <!-- Users Table -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>User Name</th>
                    <th>User Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @if (filteredUsers != null && filteredUsers.Any())
                {
                    @foreach (var user in filteredUsers)
                    {
                        <tr>
                            <td>@user.Name</td>
                            <td>@user.Username</td>
                            <td>
                                <span class="status-badge @(user.IsActive ? "status-active" : "status-inactive")">
                                    <span class="status-dot"></span>
                                    @(user.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="actions-cell">
                                <button class="btn-action btn-edit" title="Edit user" @onclick="() => OpenEditUserModal(user)">
                                    <svg viewBox="0 0 256 256" fill="currentColor">
                                        <path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"/>
                                    </svg>
                                </button>
                                <button class="btn-action btn-delete" title="Delete user" @onclick="() => ConfirmDeleteUser(user)">
                                    <svg viewBox="0 0 256 256" fill="currentColor">
                                        <path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"/>
                                    </svg>
                                </button>
                                <button class="btn-action btn-toggle" title="@(user.IsActive ? "Deactivate user" : "Activate user")" @onclick="() => ToggleUserStatus(user)">
                                    <svg viewBox="0 0 256 256" fill="currentColor">
                                        <path d="M247.31,124.76c-.35-.79-8.82-19.58-27.65-38.41C194.57,61.26,162.88,48,128,48S61.43,61.26,36.34,86.35C17.51,105.18,9,124,8.69,124.76a8,8,0,0,0,0,6.5c.35.79,8.82,19.57,27.65,38.4C61.43,194.74,93.12,208,128,208s66.57-13.26,91.66-38.34c18.83-18.83,27.3-37.61,27.65-38.4A8,8,0,0,0,247.31,124.76ZM128,192c-30.78,0-57.67-11.19-79.93-33.25A133.47,133.47,0,0,1,25,128,133.33,133.33,0,0,1,48.07,97.25C70.33,75.19,97.22,64,128,64s57.67,11.19,79.93,33.25A133.46,133.46,0,0,1,231.05,128C223.84,141.46,192.43,192,128,192Zm0-112a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="no-users">No users found</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit User Modal -->
@if (showModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(isEditing ? "Edit User" : "Add New User")</h2>
                <button class="btn-close-modal" @onclick="CloseModal">
                    <svg viewBox="0 0 256 256" fill="currentColor">
                        <path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" @bind="editingUser.DisplayName" placeholder="Enter full name" />
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" @bind="editingUser.Username" placeholder="Enter username" disabled="@isEditing" />
                </div>
                @if (!isEditing)
                {
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" @bind="editingUser.Password" placeholder="Enter password" />
                    </div>
                }
                <div class="form-group">
                    <label>Status</label>
                    <select @bind="editingUser.IsActive">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseModal">Cancel</button>
                <button class="btn-save" @onclick="SaveUser">@(isEditing ? "Save Changes" : "Add User")</button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal-overlay" @onclick="CloseDeleteModal">
        <div class="modal-content modal-delete" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user <strong>@userToDelete?.Username</strong>?</p>
                <p class="delete-warning">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseDeleteModal">Cancel</button>
                <button class="btn-delete-confirm" @onclick="DeleteUser">Delete</button>
            </div>
        </div>
    </div>
}

@code {
    private List<UserResponseDto> users = new();
    private string searchTerm = "";
    private string statusFilter = "all";
    private bool showModal = false;
    private bool showDeleteModal = false;
    private bool isEditing = false;
    private EditUserModel editingUser = new();
    private UserResponseDto? userToDelete;

    private IEnumerable<UserResponseDto> filteredUsers => users
        .Where(u => string.IsNullOrEmpty(searchTerm) || 
                    u.Username.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    u.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
        .Where(u => statusFilter == "all" || 
                    (statusFilter == "active" && u.IsActive) || 
                    (statusFilter == "inactive" && !u.IsActive));

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        var allUsers = await UserManagementService.GetAllUsersAsync();
        users = allUsers.ToList();
    }

    private void OpenAddUserModal()
    {
        isEditing = false;
        editingUser = new EditUserModel { IsActive = true };
        showModal = true;
    }

    private void OpenEditUserModal(UserResponseDto user)
    {
        isEditing = true;
        editingUser = new EditUserModel
        {
            Username = user.Username,
            DisplayName = user.Name,
            IsActive = user.IsActive
        };
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        editingUser = new();
    }

    private async Task SaveUser()
    {
        if (string.IsNullOrWhiteSpace(editingUser.Username))
            return;

        if (isEditing)
        {
            var updateRequest = new UpdateUserRequestDto
            {
                Username = editingUser.Username,
                Name = editingUser.DisplayName,
                Password = editingUser.Password,
                IsActive = editingUser.IsActive
            };
            await UserManagementService.UpdateUserAsync(updateRequest);
        }
        else
        {
            if (string.IsNullOrWhiteSpace(editingUser.Password))
                return;
            
            if (string.IsNullOrWhiteSpace(editingUser.DisplayName))
                return;

            await UserManagementService.CreateUserAsync(editingUser.Username, editingUser.DisplayName, editingUser.Password);
        }

        await LoadUsers();
        CloseModal();
    }

    private void ConfirmDeleteUser(UserResponseDto user)
    {
        userToDelete = user;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        userToDelete = null;
    }

    private async Task DeleteUser()
    {
        if (userToDelete != null)
        {
            await UserManagementService.DeleteUserAsync(userToDelete.Username);
            await LoadUsers();
        }
        CloseDeleteModal();
    }

    private async Task ToggleUserStatus(UserResponseDto user)
    {
        var updateRequest = new UpdateUserRequestDto
        {
            Username = user.Username,
            IsActive = !user.IsActive
        };
        await UserManagementService.UpdateUserAsync(updateRequest);
        await LoadUsers();
    }

    private class EditUserModel
    {
        public string Username { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public string Password { get; set; } = "";
        public bool IsActive { get; set; } = true;
    }
}
